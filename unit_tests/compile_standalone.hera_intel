#!/bin/sh -x
compile_all=1
FC=mpif90
FMS_INC=${FMS_ROOT}/include_r8
FMS_LIB=${FMS_ROOT}/lib
INCS="-I. -I${FMS_INC} -I${NETCDF}/include"
FLAGS64=" -C -traceback -real-size 64 -DSTOCHY_UNIT_TEST -c "$INCS
FLAGS=" -C -traceback -DSTOCHY_UNIT_TEST -c "$INCS
cd ..
if [ $compile_all -eq 1 ];then
   rm -f *.i90 *.i *.o *.mod lib*a
   $FC ${FLAGS64} kinddef.F90
   $FC ${FLAGS64} mpi_wrapper.F90
   $FC ${FLAGS64} -I${FMS_INC} unit_tests/fv_arrays_stub.F90
   $FC ${FLAGS64} -I${FMS_INC} unit_tests/fv_mp_stub_mod.F90
   $FC ${FLAGS64} -I${FMS_INC} unit_tests/fv_control_stub.F90
   $FC ${FLAGS64} -I${FMS_INC} unit_tests/atmosphere_stub.F90
   $FC ${FLAGS64} unit_tests/mersenne_twister.F
   $FC ${FLAGS64} stochy_namelist_def.F90
   $FC ${FLAGS64} spectral_layout.F90
   $FC ${FLAGS64} pln2eo_stochy.f
   $FC ${FLAGS64} setlats_a_stochy.f
   $FC ${FLAGS64} setlats_lag_stochy.f
   $FC ${FLAGS64} glats_stochy.f
   $FC ${FLAGS64} gozrineo_stochy.f
   $FC ${FLAGS64} dezouv_stochy.f
   $FC ${FLAGS64} dozeuv_stochy.f
   $FC ${FLAGS64} epslon_stochy.f
   $FC ${FLAGS64} four_to_grid_stochy.F
   $FC ${FLAGS64} sumfln_stochy.f
   $FC ${FLAGS64} fftpack_stochy.f
   $FC ${FLAGS64} num_parthds_stochy.f
   $FC ${FLAGS64} get_lats_node_a_stochy.f
   $FC ${FLAGS64} get_ls_node_stochy.f
   $FC ${FLAGS64} compns_stochy.F90
   $FC ${FLAGS64} stochy_internal_state_mod.F90
   $FC ${FLAGS64} getcon_lag_stochy.f
   $FC ${FLAGS64} getcon_spectral.F90
   $FC ${FLAGS64} initialize_spectral_mod.F90
   $FC ${FLAGS64} stochy_patterngenerator.F90
   $FC ${FLAGS64} stochy_data_mod.F90
   $FC ${FLAGS64} get_stochy_pattern.F90
   $FC ${FLAGS64} lndp_apply_perts.F90
   $FC ${FLAGS64} stochastic_physics.F90
   ar rv libstochastic_physics.a *.o
fi
$FC -C -traceback -real-size 64 -qopenmp -o unit_tests/standalone_stochy.x unit_tests/standalone_stochy.F90 ${INCS} -I${NETCDF}/include -L. -lstochastic_physics -L${FMS_LIB} -lfms_r8 -L${ESMF_LIB} -Wl,-rpath,${ESMF_LIB} -lesmf -L${NETCDF}/lib -lnetcdff -lnetcdf -L${HDF5_LIBRARIES} -lhdf5_hl -lhdf5 \
-L${ZLIB_LIBRARIES} -lz
